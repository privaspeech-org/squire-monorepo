# AWS Secrets Manager SecretStore Example
#
# This file shows how to configure external-secrets to use AWS Secrets Manager.
#
# Prerequisites:
# 1. Create an IAM role with access to Secrets Manager
# 2. Configure IRSA (IAM Roles for Service Accounts) or use access keys
#
# AWS Secrets Manager structure:
#   squire/github-token: {"token": "ghp_..."}
#   squire/llm-api-key: {"key": "sk-..."}
#
# Usage:
#   kubectl apply -f aws-secretsmanager-store.yaml
#
---
# Option 1: Using IRSA (Recommended for EKS)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: squire-secret-store
  namespace: squire
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1  # Change to your region
      # IRSA: Uses the service account's IAM role
      auth:
        jwt:
          serviceAccountRef:
            name: squire-external-secrets
            # The service account must have the annotation:
            # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/ROLE_NAME
---
# Service account for IRSA
apiVersion: v1
kind: ServiceAccount
metadata:
  name: squire-external-secrets
  namespace: squire
  annotations:
    # Replace with your IAM role ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/squire-secrets-role
---
# Option 2: Using Access Keys (Not recommended for production)
# Uncomment and use if IRSA is not available
#
# First create the credentials secret:
#   kubectl create secret generic aws-credentials \
#     --from-literal=access-key-id=AKIA... \
#     --from-literal=secret-access-key=... \
#     -n squire
#
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: squire-secret-store
#   namespace: squire
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         secretRef:
#           accessKeyIDSecretRef:
#             name: aws-credentials
#             key: access-key-id
#           secretAccessKeySecretRef:
#             name: aws-credentials
#             key: secret-access-key
---
# IAM Policy for the role (apply in AWS)
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Action": [
#         "secretsmanager:GetSecretValue",
#         "secretsmanager:DescribeSecret"
#       ],
#       "Resource": [
#         "arn:aws:secretsmanager:*:*:secret:squire/*"
#       ]
#     }
#   ]
# }
