# External Secrets for Squire
#
# This file defines ExternalSecret resources that sync secrets from
# external secret stores (AWS Secrets Manager, HashiCorp Vault, etc.)
# to Kubernetes Secrets.
#
# Prerequisites:
# 1. Install external-secrets operator:
#    helm repo add external-secrets https://charts.external-secrets.io
#    helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#
# 2. Create a SecretStore or ClusterSecretStore (see examples/ directory)
#
# 3. Apply this file:
#    kubectl apply -f external-secrets.yaml
#
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: squire-github-token
  namespace: squire
  labels:
    app.kubernetes.io/name: squire
    app.kubernetes.io/component: secrets
spec:
  # How often to sync (default: 1h)
  refreshInterval: 1h

  # Reference to the SecretStore
  secretStoreRef:
    name: squire-secret-store
    kind: SecretStore  # or ClusterSecretStore

  # Target Kubernetes Secret
  target:
    name: squire-github-token
    creationPolicy: Owner  # Delete secret when ExternalSecret is deleted
    deletionPolicy: Retain  # Keep secret if store becomes unavailable

  # Data to fetch from external store
  data:
    - secretKey: token  # Key in the K8s secret
      remoteRef:
        key: squire/github-token  # Path in external store
        property: token  # Property within the secret (if JSON)
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: squire-llm-api-key
  namespace: squire
  labels:
    app.kubernetes.io/name: squire
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: squire-secret-store
    kind: SecretStore

  target:
    name: squire-llm-api-key
    creationPolicy: Owner
    deletionPolicy: Retain

  data:
    - secretKey: key
      remoteRef:
        key: squire/llm-api-key
        property: key
